services:
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: unless-stopped
    command:
      - --api.dashboard=true
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@example.com}
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080" # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/letsencrypt:/letsencrypt
    networks:
      - home-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${DOMAIN:-home.local}`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik-http.rule=Host(`traefik.${DOMAIN:-home.local}`)"
      - "traefik.http.routers.traefik-http.entrypoints=web"
      - "traefik.http.routers.traefik-http.middlewares=traefik-redirect"
      - "traefik.http.middlewares.traefik-redirect.redirectscheme.scheme=https"
      - "traefik.http.services.traefik.loadbalancer.server.port=8080"

  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Chicago/New_York}
      - WEBPASSWORD=${PIHOLE_PASSWORD:-changeme}
      - PIHOLE_DNS_=8.8.8.8;1.1.1.1
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "8053:80/tcp" # Web UI (also accessible via Traefik)
    volumes:
      - ./pihole/etc:/etc/pihole
      - ./pihole/etc-dnsmasq.d:/etc/dnsmasq.d
    cap_add:
      - NET_ADMIN
    networks:
      - home-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pihole.rule=Host(`pihole.${DOMAIN:-home.local}`)"
      - "traefik.http.routers.pihole.entrypoints=websecure"
      - "traefik.http.routers.pihole.tls.certresolver=letsencrypt"
      - "traefik.http.routers.pihole-http.rule=Host(`pihole.${DOMAIN:-home.local}`)"
      - "traefik.http.routers.pihole-http.entrypoints=web"
      - "traefik.http.routers.pihole-http.middlewares=pihole-redirect"
      - "traefik.http.middlewares.pihole-redirect.redirectscheme.scheme=https"
      - "traefik.http.services.pihole.loadbalancer.server.port=80"

  syncthing:
    image: syncthing/syncthing:latest
    container_name: syncthing
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
    volumes:
      - ./syncthing/config:/var/syncthing/config
      - ./syncthing/data:/var/syncthing/data
    ports:
      - "22000:22000/tcp" # Sync protocol
      - "22000:22000/udp" # Sync protocol
      - "21027:21027/udp" # Local discovery
      - "8384:8384/tcp" # Web UI (also accessible via Traefik)
    networks:
      - home-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.syncthing.rule=Host(`syncthing.${DOMAIN:-home.local}`)"
      - "traefik.http.routers.syncthing.entrypoints=websecure"
      - "traefik.http.routers.syncthing.tls.certresolver=letsencrypt"
      - "traefik.http.routers.syncthing-http.rule=Host(`syncthing.${DOMAIN:-home.local}`)"
      - "traefik.http.routers.syncthing-http.entrypoints=web"
      - "traefik.http.routers.syncthing-http.middlewares=syncthing-redirect"
      - "traefik.http.middlewares.syncthing-redirect.redirectscheme.scheme=https"
      - "traefik.http.services.syncthing.loadbalancer.server.port=8384"

  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/New_York}
    volumes:
      - ./jellyfin/config:/config
      - ./jellyfin/cache:/cache
      - ${MEDIA_PATH:-./media}:/data/media:ro
    ports:
      - "8096:8096/tcp" # Web UI (also accessible via Traefik)
      - "8920:8920/tcp" # HTTPS
      - "7359:7359/udp" # DLNA
      - "1900:1900/udp" # DLNA
    networks:
      - home-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jellyfin.rule=Host(`jellyfin.${DOMAIN:-home.local}`)"
      - "traefik.http.routers.jellyfin.entrypoints=websecure"
      - "traefik.http.routers.jellyfin.tls.certresolver=letsencrypt"
      - "traefik.http.routers.jellyfin-http.rule=Host(`jellyfin.${DOMAIN:-home.local}`)"
      - "traefik.http.routers.jellyfin-http.entrypoints=web"
      - "traefik.http.routers.jellyfin-http.middlewares=jellyfin-redirect"
      - "traefik.http.middlewares.jellyfin-redirect.redirectscheme.scheme=https"
      - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"

  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    restart: unless-stopped
    environment:
      - HOMEPAGE_ALLOWED_HOSTS=${DOMAIN:-home.local}
      - PUID=1000
      - PGID=1000
    volumes:
      - ./homepage/config:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "3000:3000" # Web UI (also accessible via Traefik)
    networks:
      - home-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.homepage.rule=Host(`homepage.${DOMAIN:-home.local}`) || Host(`${DOMAIN:-home.local}`)"
      - "traefik.http.routers.homepage.entrypoints=websecure"
      - "traefik.http.routers.homepage.tls.certresolver=letsencrypt"
      - "traefik.http.routers.homepage-http.rule=Host(`homepage.${DOMAIN:-home.local}`) || Host(`${DOMAIN:-home.local}`)"
      - "traefik.http.routers.homepage-http.entrypoints=web"
      - "traefik.http.routers.homepage-http.middlewares=homepage-redirect"
      - "traefik.http.middlewares.homepage-redirect.redirectscheme.scheme=https"
      - "traefik.http.services.homepage.loadbalancer.server.port=3000"

networks:
  home-network:
    driver: bridge

